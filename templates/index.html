<!DOCTYPE html>
<html lang="en">
  <head>
    <title> {{ page_title }} </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">

    <style type="text/css">
      {% include "p.css" %}
    </style>

    <script type="text/javascript">
      function filter_changed(userid) {
	  var checkbox = document.getElementById("checkbox:" + userid);
	  var photos = document.getElementsByClassName(userid);
	  for (var n = 0; n < photos.length; n++) {
	      var obj = photos[n];
	      if (checkbox.checked) {
		  obj.style.display = "";
	      } else {
		  obj.style.display = "none";
	      }
	  }
      }

      function filter_change_all(is_checked) {
	  var checkboxes = document.getElementsByClassName("filter-checkbox");
	  for (var n = 0; n < checkboxes.length; n++) {
	      checkboxes[n].checked = is_checked;
	      checkboxes[n].dispatchEvent(new Event('change'));
	  }
      }

      function window_resized() {
	  const frame_width = 270;
	  const width = document.body.clientWidth - 20;
	  var comp = document.getElementById("filter-component");
	  var new_width =  (Math.floor(width / frame_width) * frame_width - 40) + "px";
	  if (width < 667) {
	      new_width = null;
	  }
	  if (comp.style.width != new_width) {
	      comp.style.width = new_width;
	  }
      }
    </script>

  </head>

  <body>

    <div id="header">
      <h1> <a href="index.cgi"> {{ page_title }} </a> </h1>
      <p> We have {{ num_photos }} pictures. </p>


      <div id="upload">
	<form id="upload-form" action="index.cgi"
	      method="POST" enctype="multipart/form-data">

	  <div class="upload-form-component">
	    Select Photos:
	    <input type="file" name="upload-file" accept="image/*,.HEIC"
		   multiple>
	  </div>

	  <div class="upload-form-component">
	    User:
	    <input type="text" name="upload-user" class="uploaded-user"
		   {% if cookie_user %}
		   value="{{ cookie_user }}"
		   {% endif %}
		   >
	  </div>

	  <div class="upload-form-component">
	    Upload: <input name="submit" type="submit" value="UpLoad!">
	  </div>

	</form>
      

	{% if message %}
	<p> {{ message }} </p>
	<a href="index.cgi"> click: [reload] !!</a>
	{% endif %}

      </div>
    </div>

    <div id="filter">
      <div id="filter-component">
	<input type="button" value="check all" onclick="filter_change_all(true)">
	<input type="button" value="uncheck all" onclick="filter_change_all(false)">
	{% for usernamemap in usernamemaps %}
	<label>
	  {{ usernamemap.0 }}<input type="checkbox"
				    id="checkbox:{{usernamemap.1}}"
				    onchange="filter_changed('{{ usernamemap.1 }}')"
				    class="filter-checkbox"
				    checked>
	</label>
	{% endfor %}
      </div>
    </div>

    <div id="content" class="clearfix">

      {% for p in photos %}
      <div class="photo-frame {{ p.userid }}">
	<div class="photo">
	  <a href="{{ p.image_url_path }}" target="_blank">
	    <img loading="lazy" src="{{ p.thumb_url_path }}">
	  </a>
	</div>
	<div class="caption">
	  {% if p.exif.date %}
	    {{ p.exif.date }} <br/>
	    {{ p.image_name }} by {{ p.username }}
	    {% if p.exif.model  %}
	      with {{ p.exif.model }}
	    {% endif %}
	  {% else %}
	    {{ p.uploadedat }} <br/>
	    {{ p.image_name }} by {{ p.username }}
	  {% endif %}
	  {% if p.error %}
	    ({{ p.error }})
	  {% endif %}
	</div>
      </div>
      {% endfor %}

    </div>

    <div id="footer">
      {{ page_title }}
    </div>

    <script type="text/javascript">
      window_resized();
      window.addEventListener("resize", window_resized);
    </script>

  </body>
</html>
